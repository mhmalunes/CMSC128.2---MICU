<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MICU CRUD System - Patient Records</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { text-align: center; }
    section { background: #fff; padding: 20px; margin: 20px auto; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,.1); max-width: 900px; }
    form { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    input[type="text"], input[type="number"], input[type="datetime-local"] {
      padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex: 1 1 180px;
    }
    label.checkbox { display: flex; align-items: center; gap: 6px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background: #fafafa; }
    button { padding: 10px 14px; border: 0; border-radius: 4px; background: #007bff; color: #fff; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #007bff; color: #fff; }
    tr:nth-child(even) { background: #f7f7f7; }
    .actions button { margin-right: 6px; }
  </style>
</head>
<body>

<h1>MICU CRUD System - Patient Records</h1>

<section>
  <h2>OUTPUT</h2>

  <form id="record-form">
    <input type="datetime-local" id="timeStamp" />
    <input type="number" id="urineMl"         placeholder="Urine (mL)" />
    <input type="number" id="ngtResidualsMl"  placeholder="NGT Residuals (mL)" />
    <input type="number" id="vomitusMl"       placeholder="Vomitus (mL)" />
    <label class="checkbox" title="Stool present">
      <input type="checkbox" id="stool" /> Stool
    </label>
    <input type="text"   id="others"          placeholder="Others" />
    <button type="submit">Add Record</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Time Stamp</th>
        <th>Urine (mL)</th>
        <th>NGT Residuals (mL)</th>
        <th>Vomitus (mL)</th>
        <th>Stool</th>
        <th>Others</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="record-list"></tbody>
  </table>
</section>

<script>
  const API = '/outputs'; // same-origin; if different host, use full URL and ensure CORS

  const fmtDateTime = (v) => {
    if (!v) return '';
    // display as local yyyy-MM-dd HH:mm
    const d = new Date(v);
    if (isNaN(d)) return v;
    const pad = (n) => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  const toIntOrNull = (v) => v === '' || v == null ? null : parseInt(v, 10);

  async function fetchRecords() {
    const tbody = document.getElementById('record-list');
    tbody.innerHTML = '';
    try {
      const res = await fetch(API);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      data.forEach(item => {
        const tr = document.createElement('tr');

        const cells = [
          item.id,
          fmtDateTime(item.timeStamp),
          item.urineMl ?? '',
          item.ngtResidualsMl ?? '',
          item.vomitusMl ?? '',
          item.stool ? 'Yes' : 'No',
          item.others ?? ''
        ];
        cells.forEach(val => {
          const td = document.createElement('td');
          td.textContent = val;
          tr.appendChild(td);
        });

        // Actions
        const actionsTd = document.createElement('td');
        actionsTd.className = 'actions';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = async () => {
          // simple prompts; in production, use a proper form/modal
          const timeStamp = prompt('Time Stamp (YYYY-MM-DDTHH:mm:ss) or blank to keep', item.timeStamp ? item.timeStamp.replace('.000','') : '');
          const urineMl = prompt('Urine mL', item.urineMl ?? '');
          const ngtResidualsMl = prompt('NGT Residuals mL', item.ngtResidualsMl ?? '');
          const vomitusMl = prompt('Vomitus mL', item.vomitusMl ?? '');
          const stool = confirm('Is stool present? Click OK for Yes, Cancel for No.');
          const others = prompt('Others', item.others ?? '');

          const body = {
            timeStamp: timeStamp ? timeStamp : item.timeStamp, // keep old if blank
            urineMl: toIntOrNull(urineMl),
            ngtResidualsMl: toIntOrNull(ngtResidualsMl),
            vomitusMl: toIntOrNull(vomitusMl),
            stool,
            others: others || null
          };

          const res = await fetch(`${API}/${item.id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
          });
          if (!res.ok) alert('Update failed: ' + res.status + ' ' + await res.text());
          await fetchRecords();
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = async () => {
          if (!confirm('Delete this record?')) return;
          const res = await fetch(`${API}/${item.id}`, { method: 'DELETE' });
          if (!res.ok) alert('Delete failed: ' + res.status + ' ' + await res.text());
          await fetchRecords();
        };

        actionsTd.appendChild(editBtn);
        actionsTd.appendChild(delBtn);
        tr.appendChild(actionsTd);
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error('Fetch failed:', err);
      alert('Load failed: ' + err.message);
    }
  }

  document.getElementById('record-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    // Convert datetime-local to ISO with seconds
    const tsRaw = document.getElementById('timeStamp').value; // e.g. "2025-10-14T19:45"
    const body = {
      timeStamp: tsRaw ? tsRaw + ':00' : null, // backend auto-fills if null
      urineMl:         toIntOrNull(document.getElementById('urineMl').value),
      ngtResidualsMl:  toIntOrNull(document.getElementById('ngtResidualsMl').value),
      vomitusMl:       toIntOrNull(document.getElementById('vomitusMl').value),
      stool:           document.getElementById('stool').checked,
      others:          document.getElementById('others').value || null
    };

    try {
      const res = await fetch(API, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(await res.text());
      e.target.reset();
      await fetchRecords();
    } catch (err) {
      console.error('Create failed:', err);
      alert('Add failed: ' + err.message);
    }
  });

  fetchRecords();
</script>

</body>
</html>
